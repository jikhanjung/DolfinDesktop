<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>DolfinExplorer</title>
</head>
<body>
	<div id="date_div" style="position:relative;margin:auto;height:35px;width:100%;text-align:center;z-index:20;"></div>
	<div id="finid_div" style="position:absolute;left:20px;top:35px;height:90vh;width:10vw;z-index:10;"></div>
	<div id="map" style="position:absolute;top:0px;left:0px;height:100%;width:100%;z-index:0;"></div>
	<script type="text/javascript" src="jquery-3.5.1.min.js"></script>
	<script type="text/javascript" src="http://dapi.kakao.com/v2/maps/sdk.js?appkey=d77a7932b44514f9642821b2c24b2b50"></script>
	<script type="text/javascript" src="dolfinid_data.js"></script>
	<script>
		var container = document.getElementById('map');
		var options = {
			center: new kakao.maps.LatLng(33, 126),
			level: 9
		};

		var map = new kakao.maps.Map(container, options);
		var zoomControl = new kakao.maps.ZoomControl();
		map.addControl(zoomControl, kakao.maps.ControlPosition.RIGHT);

var lat_sum=0, lon_sum=0, data_count=0;
var lat_max=0, lat_min=999, lon_max=0, lon_min=999;
var key_list = Object.keys(finid_hash);
var marker_hash = {};
var bounds = new kakao.maps.LatLngBounds();
var location_hash = {};
var date_hash = {};
key_list.sort()

for(key_idx=0;key_idx<key_list.length;key_idx++){
	var fin_data = finid_hash[key_list[key_idx]];
	var marker_list = [];
	var fin_id = key_list[key_idx];
	add_new_button(fin_id);
	for(idx=0;idx<fin_data.length;idx++){
		if( fin_data[idx]['latitude'] > 0 ){
			//alert(fin_data[idx]['datetime']);

			var marker_pos  = new kakao.maps.LatLng(fin_data[idx]['latitude'], fin_data[idx]['longitude']);
			lat = fin_data[idx]['latitude'];
			lon = fin_data[idx]['longitude'];
			lat_sum += lat;
			lon_sum += lon;
			data_count += 1;

			location_key = lat + '_' + lon;
			if(!location_hash.hasOwnProperty(location_key)){

				var marker_instance = new kakao.maps.Marker({position: marker_pos});
				var div_instance = '<div class="label" id="' + location_key + '"></div>';
				var overlay_instance = new kakao.maps.CustomOverlay({'position': marker_pos,'marker': marker_instance,'content': div_instance});
				var iwContent = '<div style="padding:5px;"></div>';
				var iwPosition = marker_pos;
				var infowindow_instance = new kakao.maps.InfoWindow({'position' : marker_pos, 'content' : div_instance, 'removable' : true});
				location_hash[location_key] = { 'marker': marker_instance,
												'fin_hash': {},
												'overlay': overlay_instance,
												'infowindow': infowindow_instance
											  };
				location_hash[location_key]['marker'].setMap(map);
				//overlay_instance.setMap(map);
				bounds.extend(marker_pos);

				//kakao.maps.event.addListener(location_hash[location_key]['marker'], 'click', function() { alert(location_key); location_hash[location_key]['overlay'].open(map); } );
				kakao.maps.event.addListener(marker_instance, 'mouseover', makeOverListener(map, marker_instance, infowindow_instance));
    			kakao.maps.event.addListener(marker_instance, 'mouseout', makeOutListener(infowindow_instance));

			}

			// 새로운 날짜일 경우 date_hash 에 location_key 추가.
			date_array = fin_data[idx]['datetime'].split(" ");
			yyyymmdd = date_array[0]
			if( !date_hash.hasOwnProperty(yyyymmdd) ){
				date_hash[yyyymmdd] = []
			}
			if( !(date_hash[yyyymmdd].includes(location_key)) ) {
				date_hash_len = date_hash[yyyymmdd].length
				date_hash[yyyymmdd][date_hash_len] = location_key;
				//console.log( yyyymmdd, location_key, date_hash[yyyymmdd])
			}

			fin_hash = location_hash[location_key]['fin_hash'];
			if( !fin_hash.hasOwnProperty(fin_id)){
				fin_hash[fin_id] = []
			}
			fin_hash[fin_id][fin_hash[fin_id].length] = fin_data[idx];
			fin_list = Object.keys(fin_hash);
			
			location_hash[location_key]['infowindow'].setContent('<div class="label" id="' + location_key + '">' + fin_list.join(", ") + '</div>');

		}
	}
}



var date_list = Object.keys(date_hash);
date_list.sort();
for(idx=0;idx<date_list.length;idx++){
	add_new_date(date_list[idx]);
	//console.log( date_list[idx], date_hash[date_list[idx]] );
}
add_new_button("All");
add_new_date("All");
//alert( Object.keys(location_hash) );

var lat_avr = lat_sum / data_count;
var lon_avr = lon_sum / data_count;
//alert( lat_min + ', ' + lon_min + ', ' + lat_max + ', ' + lon_max );
//var map_bound = kakao.maps.LatLngBounds( sw, ne );
//alert(lat_avr + ', ' + lon_avr);
//map.setCenter(new kakao.maps.LatLng(lat_avr, lon_avr));
map.setBounds(bounds);
//alert(fin1_data.length);

// 인포윈도우를 표시하는 클로저를 만드는 함수입니다 
function makeOverListener(map, marker, infowindow) {
    return function() {
        infowindow.open(map, marker);
    };
}

// 인포윈도우를 닫는 클로저를 만드는 함수입니다 
function makeOutListener(infowindow) {
    return function() {
        infowindow.close();
    };
}

function add_new_button(fin_id){
	var new_span = document.createElement("span");
	var button = document.createElement('button');
	button.setAttribute("onclick","show_marker('" + fin_id + "');");
	button.style.width = "60px";
	button.appendChild(document.createTextNode(fin_id));
	new_span.appendChild(button);
	//new_span.style.overflow="scroll";
	//if( key_idx > 0 && !((key_idx)%2) ) { document.getElementById("finid_div").appendChild(document.createElement('br')); }
	document.getElementById("finid_div").appendChild(new_span);
	//document.getElementById("finid_div").appendChild(new_span);
	document.getElementById("finid_div").appendChild(document.createElement('br'));
}
function add_new_date(observe_date){
	var new_span = document.createElement("span");
	var button = document.createElement('button');
	button.setAttribute("onclick","show_date('" + observe_date + "');");
	button.appendChild(document.createTextNode(observe_date));
	new_span.appendChild(button);
	document.getElementById("date_div").appendChild(new_span);
	//if( key_idx > 0 && !((key_idx)%15) ) { document.getElementById("finid_div").appendChild(document.createElement('br')); }
	document.getElementById("date_div").appendChild(new_span);
}


function show_marker(fin_id) {
	var local_bounds = new kakao.maps.LatLngBounds();
	var location_list = Object.keys(location_hash);
	for(location_idx=0;location_idx<location_list.length;location_idx++){
		var location_key = location_list[location_idx];
		var location_info = location_hash[location_key];
		var pos = null;
		if( fin_id == 'All' ) {
			location_info['marker'].setMap(map);
			pos = location_info['marker'].getPosition();
		} else if(!location_info['fin_hash'].hasOwnProperty(fin_id)){
			location_info['marker'].setMap(null);
		} else {
			location_info['marker'].setMap(map);
			pos = location_info['marker'].getPosition();
		}
		if( pos != null ){
			local_bounds.extend(pos);
			//bounds.extend(marker_pos);
		}
	}
	map.setBounds(local_bounds);
}

function show_date(observe_date) {
	var local_bounds = new kakao.maps.LatLngBounds();
	var location_list_to_show = date_hash[observe_date];
	//alert(observe_date);
	//console.log( observe_date, location_list_to_show );
	var location_list = Object.keys(location_hash);
	for(location_idx=0;location_idx<location_list.length;location_idx++){
		var location_key = location_list[location_idx];
		var location_info = location_hash[location_key];
		var pos = null;
		//console.log( location_key, location_list_to_show );

		if( observe_date == 'All' ) {
			location_info['marker'].setMap(map);
			pos = location_info['marker'].getPosition();
		} else if( location_list_to_show.includes(location_key) ){
			location_info['marker'].setMap(map);
			pos = location_info['marker'].getPosition();
		} else {
			location_info['marker'].setMap(null);
		}
		if( pos != null ){
			local_bounds.extend(pos);
			//bounds.extend(marker_pos);
		}
	}
	map.setBounds(local_bounds);
}

function distance(lat1, lon1, lat2, lon2 ) {
	if ((lat1 == lat2) && (lon1 == lon2)) {
		return 0;
	}
	else {
		var radlat1 = Math.PI * lat1/180;
		var radlat2 = Math.PI * lat2/180;
		var theta = lon1-lon2;
		var radtheta = Math.PI * theta/180;
		var dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
		if (dist > 1) {
			dist = 1;
		}
		dist = Math.acos(dist);
		dist = dist * 180/Math.PI;
		dist = dist * 60 * 1.1515;
		dist = dist * 1.609344;
		return dist;
	}
}
</script>
</body>
</html>